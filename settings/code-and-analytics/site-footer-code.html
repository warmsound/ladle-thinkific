<style type="text/css">
    /* Set background image of entire course player, including behind header.
       Clear existing background colours. */
    /*
    .course-player {
        background: rgba(0, 0, 0, 0) !important;
    }
    .course-player > main > section {
        background: rgba(0, 0, 0, 0) !important;
    }
    #main-content {
        background: rgba(0, 0, 0, 0) !important;
    }
    #player-wrapper {
        background: #ffffff url('https://raw.githubusercontent.com/warmsound/ladle-thinkific/master/resources/lesson-background.png');
    }
    */
    
    /* Hard-code semi-transparent background colour for top bar. */
    .course-player__top-bar {
        background-color: rgba(27, 158, 234, 0.5) !important;
    }
</style>

<script type="text/javascript">
    $(function() {
        if(typeof(CoursePlayerV2) !== 'undefined') {

            // Attempt to determine full course data, for better event tracking.
            let courseData;

            // Determine course "slug" (course ID used in URL) from hidden input.
            const courseSlugInput = document.querySelector('input#CourseSlug');
            const courseSlug = courseSlugInput && courseSlugInput.value;
            if (courseSlug) {

                // Request course data using undocumented course player V2 API:
                // https://ladle.thinkific.com/api/course_player/v2/courses/[courseSlug]
                get('https://ladle.thinkific.com/api/course_player/v2/courses/' + courseSlug, function() {
                    courseData = JSON.parse(this.responseText);
                });
            }

            CoursePlayerV2.on('hooks:contentWillChange', function(data) {
                console.log('contentWillChange', data);
            });

            // Documentation about sending parameterised events to ActiveCampaign: https://segment.com/docs/destinations/activecampaign/.
            // Documentation about CoursePlayerV2 hooks: https://help.thinkific.com/support/solutions/articles/229501-how-to-track-additional-events-in-mixpanel-using-event-hooks.
            // - This is fired after a student has navigated to a new lesson.
            CoursePlayerV2.on('hooks:contentDidChange', function(data) {
                console.log('contentDidChange', data);
                
                if (courseSlug) {

                    // Request enrollment data using undocumented course player V2 API:
                    // https://ladle.thinkific.com/api/course_player/v2/enrollments?course_slug=[courseSlug]
                    get('https://ladle.thinkific.com/api/course_player/v2/enrollments?course_slug=' + courseSlug, function() {
                        let enrollmentData = JSON.parse(this.responseText);

                        let lessonIsComplete = (enrollmentData.user_contents.filter(function(content) {
                            return ((content.content_id == data.lesson.id) && (content.complete == true));
                        }).length > 0);

                        if (!lessonIsComplete) {

                            // Send lesson started data to Segment, for incomplete lessons only.
                            analytics.track('Lesson Started', {
                                acValue: data.lesson.name //getFriendlyLessonId(data)
                            });
                        }
                    });
                }

                // Send lesson viewed data to Segment, for both incomplete and completed lessons.
                analytics.track('Lesson Viewed', {
                    acValue: data.lesson.name
                });
            });

            // - This is fired when the student clicks the "Next" button and completes the lesson.
            CoursePlayerV2.on('hooks:contentWasCompleted', function(data) {
                console.log('contentWasCompleted', data);

                data.user = Thinkific.current_user;
                
                // Send lesson completion data to Google Sheets.
                const URL = 'https://script.google.com/macros/s/AKfycbwjN5WYg9KqiBVssqNtFT4XvRoiqIS4L5hScAp8rNIMptOY4l4/exec';
                
                // Param names must match sheet headers.
                let params = {
                    sheet: 'lesson_completions',
                    email: data.user.email,
                    name: data.user.full_name,
                    user_id: data.user.id,
                    lesson: data.lesson.name,
                    lesson_id: data.lesson.id
                };

                get(URL + '?' + paramsToURLQuery(params));

                if (courseSlug) {

                    // Request enrollment data using undocumented course player V2 API:
                    // https://ladle.thinkific.com/api/course_player/v2/enrollments?course_slug=[courseSlug]
                    get('https://ladle.thinkific.com/api/course_player/v2/enrollments?course_slug=' + courseSlug, function() {
                        let enrollmentData = JSON.parse(this.responseText);

                        let thisChapter = courseData.chapters.filter(function(chapter) {
                            return (chapter.id == data.chapter.id);
                        })[0];

                        let completedLessonsInThisChapter = enrollmentData.user_contents.filter(function(content) {
                            // This lesson is in this chapter AND this lesson is complete.
                            return ((thisChapter.content_ids.indexOf(content.content_id) != -1) && content.complete);
                        });

                        // All lessons in this chapter are complete.
                        let thisChapterIsComplete = (completedLessonsInThisChapter.length == thisChapter.content_ids.length);

                        if (thisChapterIsComplete) {
                            console.log('Chapter Complete');

                            // Send chapter completed data to Segment.
                            //analytics.track('Lesson Started', {
                            //    acValue: data.lesson.name //getFriendlyLessonId(data)
                            //});
                        }
                    });
                }

                // Send lesson completion data to Segment.
                analytics.track('Lesson Completed', {
                    acValue: data.lesson.name
                });
            });

            function get(url, onSuccessResponse) {
                let xhr = new XMLHttpRequest();
                if (onSuccessResponse) {
                    xhr.onreadystatechange = function() {
                        if ((this.readyState == 4) && (this.status == 200)) {
                            onSuccessResponse.call(this);
                        }
                    };
                }                
                xhr.open("GET", url);
                xhr.send();
            }

            function paramsToURLQuery(params) {
                return Object.keys(params)
                    .map(function(key){
                        return key + '=' + encodeURIComponent(params[key])
                    })
                    .join('&');
            }

            // Return string in format:
            // "[chapter_index]-[lesson_index]"
            // where all indices are zero-based.
            function getFriendlyLessonId(data) {
                let chapterIds = courseData.course.chapter_ids;
                return chapterIds.indexOf(parseInt(data.chapter.id))
                    + '-'
                    + data.lesson.position
            }
        }
    });

    // Segment integration.
    !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t,e){var n=document.createElement("script");n.type="text/javascript";n.async=!0;n.src="https://cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(n,a);analytics._loadOptions=e};analytics.SNIPPET_VERSION="4.1.0";
    analytics.load("CqHOerUm8gocR9dwT9yZNFtt78jhM3uz");
    analytics.page();
    }}();
</script>